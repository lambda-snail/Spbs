@page "/expenses/{ExpenseId}"

@if (_expense is not null)
{
    <MudPaper Class="pa-4 mt-4">
        <MudText>
            @_expense.Name
        </MudText>


        <MudGrid>
            <MudItem xs="12">
                <MudTextField T="string"
                              ReadOnly="true"
                              Text="@_expense.Description"
                              Lines="4"
                              Label="Description"
                              Variant="Variant.Text"
                              Margin="Margin.Dense">
                </MudTextField>
            </MudItem>

            <MudItem xs="6">
                <MudTextField T="string"
                              ReadOnly="true"
                              Text="@_expense.Date.ToString("s")"
                              Label="Date"
                              Variant="Variant.Text"
                              Margin="Margin.Dense">
                </MudTextField>
            </MudItem>

            <MudItem xs="6">
                <MudTextField T="string"
                              ReadOnly="true"
                              Text="@_expense.Venue"
                              Label="Venue"
                              Variant="Variant.Text"
                              Margin="Margin.Dense">
                </MudTextField>
            </MudItem>

            <MudItem xs="6">
                <MudTextField T="string"
                              ReadOnly="true"
                              Text=@(_expense.Total + " " + _expense.Currency)
                              Label="Total"
                              Variant="Variant.Text"
                              Margin="Margin.Dense">
                </MudTextField>
            </MudItem>

            <MudItem xs="6">
                <MudTextField T="string"
                              ReadOnly="true"
                              Text="@_expense.Category"
                              Label="Category"
                              Variant="Variant.Text"
                              Margin="Margin.Dense">
                </MudTextField>

            </MudItem>

            <MudDivider/>

            <MudItem xs="12">
                @if (_expense?.Tags is not null)
                {
                    @foreach (var tag in _expense!.Tags.Split(" "))
                    {
                        <MudChip Color="Color.Primary">@tag</MudChip>
                    }
                }

                <MudIconButton Icon="@Icons.Material.Filled.Add" aria-label="add tag" OnClick="@AddTagList"/>
            </MudItem>
            <MudItem>
                <MudButton Icon="@Icons.Material.Filled.Edit"
                           OnClick="@ToggleEditMode"
                           Color="Color.Primary">
                    Edit Expense
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>


    <MudPaper Elevation="25" Class="mt-4 mb-2">
        <MudToolBar>
            <MudIconButton Icon="@Icons.Material.Filled.Add"
                           OnClick="@(AddExpenseItem)"
                           Color="Color.Primary" />
            
            <MudIconButton Icon="@Icons.Material.Filled.EditNote"
                           Color="Color.Default"/>
                
            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                           Color="Color.Secondary" />
        </MudToolBar>
    </MudPaper>


    <MudDataGrid T="ExpenseItem"
                 @ref="@_grid"
                 Items="@_expense.Items"
                 ReadOnly="false"
                 EditMode="DataGridEditMode.Form"
                 EditTrigger="DataGridEditTrigger.OnRowClick"
                 Filterable="true"
                 SortMode="@SortMode.Multiple"
                 MultiSelection="true"
                 Groupable="false">
        <Columns>
            <SelectColumn T="ExpenseItem"/>
            <PropertyColumn Property="x => x.Name"/>
            <PropertyColumn Property="x => x.Quantity"/>
            <PropertyColumn Property="x => x.Price"/>
            
            <TemplateColumn T="ExpenseItem" Title="Total">
                <CellTemplate>
                    @context.Item.GetCostOfItem() @_expense.Currency
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="ExpenseItem"/>
        </PagerContent>
    </MudDataGrid>
}

<EditExpenseComponent @ref="_editExpenseComponent" GetUserId="() => _userId" OnUpdateCallback="ExpenseUpdated"></EditExpenseComponent>
<EditExpenseItemComponent @ref="_editExpenseItemComponent" OnUpdateCallback="ExpenseItemUpdated"></EditExpenseItemComponent>