@page "/accounts/import-expenses"

<MudText Typo="Typo.h4" GutterBottom="true" Class="mt-4">Import Expenses</MudText>

@if (_filteredExpenseModels is { Count:0 })
{
    <MudText Color="Color.Error" Typo="Typo.body1" GutterBottom="true" Class="mt-4">
        There are no expenses to load. Please go back to the bank integration page to perform an import.
    </MudText>
}
else
{
    <MudPaper>

        <MudPaper Elevation="25">
            <MudToolBar>
                @if (_selectedTransactions is { Count: >0 })
                {
                    <MudTooltip Delay="600" Text="Toggle include status of selection">
                        <MudButton OnClick="() => ToggleInclude(_selectedTransactions)" Color="Color.Primary">
                            @(_includeAllSwitchValue ? "Include Selection" : "Exclude Selection")
                        </MudButton>
                    </MudTooltip>
                }
                else
                {
                    <MudButton OnClick="() => ToggleInclude(_filteredExpenseModels)" Color="Color.Primary">
                        @(_includeAllSwitchValue ? "Include All" : "Exclude All")
                    </MudButton>
                }

                <MudSwitch @bind-Checked="_includeAllSwitchValue" Label="Toggle Include" Color="Color.Dark"/>

                <MudSpacer/>

                <MudTooltip Delay="600" Text="Import the selected transactions">
                    <MudIconButton OnClick="ImportExpenses" Icon="@Icons.Material.Filled.FileDownload" Color="Color.Secondary"/>
                </MudTooltip>
            </MudToolBar>
        </MudPaper>

        <MudDataGrid T="ImportExpensesViewModel"
                     @ref="_grid"
                     Items="@_filteredExpenseModels"
                     ReadOnly="false"
                     EditMode="DataGridEditMode.Form"
                     EditTrigger="DataGridEditTrigger.OnRowClick"
                     CommittedItemChanges="OnTransactionEdited"
                     MultiSelection="true"
                     Filterable="false"
                     Hideable="false"
                     SelectedItemsChanged="@OnSelectionChanged"
                     Dense="true">
            <Columns>
                <SelectColumn T="ImportExpensesViewModel"/>

                <PropertyColumn T="ImportExpensesViewModel" TProperty="double" Title="Amount">
                    <CellTemplate>
                        @context.Item.TransactionAmount.Amount
                    </CellTemplate>
                    <EditTemplate>
                        <MudNumericField @bind-Value="@context.Item.TransactionAmount.Amount" Label="Amount" Variant="Variant.Text" Min="0.0"/>
                    </EditTemplate>
                </PropertyColumn>

                <PropertyColumn T="ImportExpensesViewModel" TProperty="string" Title="Currency">
                    <CellTemplate>
                        @context.Item.TransactionAmount.Currency
                    </CellTemplate>
                    <EditTemplate>
                        <MudTextField @bind-Value="@context.Item.TransactionAmount.Currency" Label="Currency" Variant="Variant.Text" />
                    </EditTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.ValueDate" Title="Date" IsEditable="false"/>

                <PropertyColumn Property="x => x.RemittanceInformationUnstructured" Title="Name"/>

                <TemplateColumn IsEditable="false" T="ImportExpensesViewModel" CellClass="d-flex justify-end">
                    <CellTemplate>
                        <MudStack Row="true">
                            @if (context.Item.IncludeInImport)
                            {
                                <MudChip Color="Color.Primary">Include in Import</MudChip>
                            }
                            else
                            {
                                <MudChip Color="Color.Secondary">Exclude from Import</MudChip>
                            }

                            @if (context.Item.IsPending)
                            {
                                <MudChip Color="Color.Dark">Transaction Pending</MudChip>
                            }
                        </MudStack>
                    </CellTemplate>
                    <EditTemplate>
                        <MudSwitch @bind-Checked="context.Item.IncludeInImport" Label="Include in Import?" Color="Color.Secondary"/>
                    </EditTemplate>
                </TemplateColumn>

            </Columns>
            <PagerContent>
                <MudDataGridPager T="ImportExpensesViewModel"/>
            </PagerContent>
        </MudDataGrid>


    </MudPaper>
}